name: Build singleinstance

# 触发条件：提交代码/手动触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest # 使用 GitHub 托管的 Windows 虚拟机（预装 VS Build Tools）
    
    steps:
      # 步骤1：拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：配置 VS Build Tools 环境（自动安装 C++ 生成工具）
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      # 步骤3：编译项目（Release 和 ReleaseHidden 版本）
      - name: Build Release version
        run: msbuild singleinstance.sln /t:Build /p:Configuration=Release /p:Platform=x64 /m

      - name: Build ReleaseHidden version
        run: msbuild singleinstance.sln /t:Build /p:Configuration=ReleaseHidden /p:Platform=x64 /m

      # 步骤4：打包编译产物（方便下载）
      - name: Package artifacts
        run: |
          mkdir -p build_output
          copy x64\Release\singleinstance.exe build_output\
          copy x64\ReleaseHidden\singleinstance_hidden.exe build_output\
          7z a singleinstance.zip build_output\*

      # 步骤5：上传编译产物（可在 Actions 页面下载）
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: singleinstance-build
          path: singleinstance.zip
          retention-days: 90 # 产物保留90天
